# Data Dictionary - Hackathon MVP
# Minimal documentation for 14 core tables (Updated: 2025-11-18)
# MIGRATION: Removed academic_years and semesters, added knowledge_nodes and node_syllabus_concepts
# MIGRATION (2025-11-18): Added unlock_events and user_stats tables, updated flashcards with unlock fields

users:
  description: "Student accounts with basic auth info"
  source: "auth system"
  fields:
    id:
      type: uuid
      description: "Primary key"
      required: true
    email:
      type: string
      description: "Student email for login"
      required: true
      pii: true
    name:
      type: string
      description: "Display name"
      required: false
    created_at:
      type: timestamp
      description: "Account creation time"
      required: true

subjects:
  description: "Academic subjects (Philosophy, Biology, Economics, etc.)"
  source: "admin seed data"
  fields:
    id:
      type: uuid
      description: "Primary key"
      required: true
    name:
      type: string
      description: "Subject name"
      required: true
    created_at:
      type: timestamp
      required: true

courses:
  description: "Individual courses (UEs) within subject structure - simplified hierarchy"
  source: "admin seed data + syllabus PDF processing"
  fields:
    id:
      type: uuid
      description: "Primary key"
      required: true
    code:
      type: string
      description: "Official course code (LU1PH51F, BIOL2001, ECON1101)"
      required: true
    name:
      type: string
      description: "Course name (Métaphysique, Cell Biology, etc.)"
      required: true
    subject_id:
      type: uuid
      description: "FK to subjects"
      required: true
      index: true
    ue_number:
      type: string
      description: "UE number for French system (UE 1, UE 2, etc.)"
      required: false
    syllabus_url:
      type: string
      description: "Link to syllabus PDF"
      required: false
    created_at:
      type: timestamp
      required: true

user_courses:
  description: "Student enrollment in courses with progress tracking"
  source: "enrollment actions"
  fields:
    user_id:
      type: uuid
      description: "FK to users"
      required: true
    course_id:
      type: uuid
      description: "FK to courses"
      required: true
      index: true
    is_active:
      type: boolean
      description: "Only one active course per user for MVP"
      required: true
    learned_count:
      type: integer
      description: "Pre-computed count of matched concepts (confidence >=0.8). For 'X learned' display."
      required: true
      index: true
    created_at:
      type: timestamp
      required: true

knowledge_nodes:
  description: "Flexible tree-based knowledge hierarchy within subjects (e.g., Epistemology → Kant → Categorical Imperative)"
  source: "admin seed data or AI-generated from content"
  fields:
    id:
      type: uuid
      description: "Primary key"
      required: true
    subject_id:
      type: uuid
      description: "FK to subjects"
      required: true
      index: true
    parent_id:
      type: uuid
      description: "FK to knowledge_nodes (self-referential for tree structure). NULL = root node"
      required: false
      index: true
    name:
      type: string
      description: "Node name (Epistemology, Ethics, Kant, Categorical Imperative, etc.)"
      required: true
    slug:
      type: string
      description: "URL-friendly identifier, unique per subject (e.g., 'epistemology', 'kant')"
      required: false
    order:
      type: integer
      description: "Display order among siblings for consistent tree rendering"
      required: true
      default: 0
    metadata:
      type: json
      description: "Flexible JSON metadata for future extensions (descriptions, icons, etc.)"
      required: false
    created_at:
      type: timestamp
      required: true
    updated_at:
      type: timestamp
      required: true

node_syllabus_concepts:
  description: "Junction table linking syllabus concepts to knowledge tree nodes for organization"
  source: "admin curation or AI-suggested attachments"
  fields:
    node_id:
      type: uuid
      description: "FK to knowledge_nodes"
      required: true
      index: true
    syllabus_concept_id:
      type: uuid
      description: "FK to syllabus_concepts"
      required: true
      index: true
    added_by_user_id:
      type: uuid
      description: "User who attached this concept (optional, for tracking)"
      required: false
    created_at:
      type: timestamp
      required: true

syllabus_concepts:
  description: "Required concepts per course (extracted from syllabus). Can optionally be organized into knowledge tree via node_syllabus_concepts"
  source: "admin pre-load before hackathon or AI extraction"
  fields:
    id:
      type: uuid
      description: "Primary key"
      required: true
    course_id:
      type: string
      description: "FK to courses"
      required: true
      index: true
    concept_text:
      type: string
      description: "Concept name (Categorical Imperative, Mitosis, Supply and Demand)"
      required: true
    category:
      type: string
      description: "Optional grouping (Ethics, Epistemology, Cell Biology)"
      required: false
    importance:
      type: integer
      description: "1=supplemental, 2=important, 3=core"
      required: false
    order:
      type: integer
      description: "Display order in syllabus"
      required: true
    created_at:
      type: timestamp
      required: true

content_jobs:
  description: "Unified content processing pipeline (formerly video_jobs). Supports YouTube, TikTok, PDFs, articles, podcasts. Table name remains 'video_jobs' for backward compatibility."
  source: "student-submitted URLs or file uploads"
  migration: "2025-11-18: VideoJob → ContentJob with ContentType enum"
  fields:
    id:
      type: uuid
      description: "Primary key"
      required: true
    user_id:
      type: uuid
      description: "FK to users"
      required: true
      index: true
    url:
      type: string
      description: "Source URL (YouTube, TikTok, PDF URL, article URL, podcast URL)"
      required: true
    content_type:
      type: enum
      description: "youtube | tiktok | pdf | url | podcast"
      required: true
      default: youtube
      index: true
    youtube_video_id:
      type: string
      description: "Video-specific: Extracted YouTube video ID for API calls"
      required: false
    tiktok_video_id:
      type: string
      description: "Video-specific: Extracted TikTok video ID"
      required: false
    file_name:
      type: string
      description: "PDF-specific: Original filename"
      required: false
    file_size:
      type: integer
      description: "PDF-specific: File size in bytes"
      required: false
    page_count:
      type: integer
      description: "PDF-specific: Number of pages"
      required: false
    extracted_text:
      type: text
      description: "Extracted text from any content type (transcript for videos, text for PDFs). Column name: 'transcript' (mapped via @map for backward compatibility)."
      required: false
      pii: false
    status:
      type: string
      description: "transcript_fetched | processing | completed | failed | cancelled. Phase 1 (transcript_fetched) → Phase 2 (processing/completed)"
      required: true
      index: true
    processed_concepts_count:
      type: integer
      description: "For 'Extracted 4 concepts' message in UI"
      required: false
    error_message:
      type: string
      description: "Error details if status=failed"
      required: false
    created_at:
      type: timestamp
      required: true
    completed_at:
      type: timestamp
      description: "When processing finished"
      required: false

concepts:
  description: "AI-extracted atomic concepts from any content type (videos, PDFs, articles, podcasts)"
  source: "GPT-4/Claude extraction"
  fields:
    id:
      type: uuid
      description: "Primary key"
      required: true
    content_job_id:
      type: uuid
      description: "FK to content_jobs (column name: 'videoJobId' via @map for backward compatibility)"
      required: true
      index: true
    concept_text:
      type: string
      description: "Extracted concept name"
      required: true
    definition:
      type: string
      description: "1-2 sentence definition from AI"
      required: false
    timestamp:
      type: string
      description: "MM:SS format linking to video moment (video-specific, null for PDFs/articles)"
      required: false
    confidence:
      type: decimal
      description: "AI confidence score (0.0-1.0)"
      required: true
      index: true
    language:
      type: string
      description: "Detected language of concept (en, fr, es, de, etc.). Preserved from original content. Used for cross-lingual matching with multilingual embeddings."
      required: true
      default: en
      index: true
    created_at:
      type: timestamp
      required: true

concept_matches:
  description: "Matches between extracted concepts and syllabus requirements"
  source: "embedding similarity + AI reasoning"
  fields:
    id:
      type: uuid
      description: "Primary key"
      required: true
    concept_id:
      type: uuid
      description: "FK to concepts"
      required: true
      index: true
    syllabus_concept_id:
      type: uuid
      description: "FK to syllabus_concepts"
      required: true
      index: true
    confidence:
      type: decimal
      description: "Match confidence (0.0-1.0). >=0.8 = matched"
      required: true
      index: true
    match_type:
      type: string
      description: "exact | related | example-of | no-match"
      required: false
    rationale:
      type: string
      description: "AI explanation of why concepts match"
      required: false
    user_feedback:
      type: string
      description: "correct | incorrect | uncertain (MVP: data collection only)"
      required: false
    created_at:
      type: timestamp
      required: true

flashcards:
  description: "Auto-generated Q&A flashcards with unlock system (locked → unlocked → mastered)"
  source: "GPT-4/Claude generation from concept_matches"
  fields:
    id:
      type: uuid
      description: "Primary key"
      required: true
    syllabus_concept_id:
      type: uuid
      description: "FK to syllabus_concepts (always present)"
      required: true
      index: true
    concept_match_id:
      type: uuid
      description: "FK to concept_matches (NULL = locked, NOT NULL = unlocked)"
      required: false
      index: true
    user_id:
      type: uuid
      description: "FK to users (flashcards are per-user)"
      required: true
      index: true
    question:
      type: string
      description: "Active recall question (always present, from syllabus)"
      required: true
    answer:
      type: string
      description: "Concise answer (NULL = locked, NOT NULL = unlocked)"
      required: false
    question_translation:
      type: string
      description: "Translation of question (for bilingual flashcards)"
      required: false
    answer_translation:
      type: string
      description: "Translation of answer (for bilingual flashcards)"
      required: false
    language:
      type: string
      description: "Primary language (en, fr, es, de, etc.)"
      required: true
      default: en
    difficulty:
      type: string
      description: "easy | medium | hard"
      required: true
      default: medium
    hints:
      type: json
      description: "Array of hint strings (available when locked)"
      required: false
    state:
      type: string
      description: "locked | unlocked | mastered"
      required: true
      default: locked
      index: true
    unlocked_at:
      type: timestamp
      description: "When answer was revealed"
      required: false
    unlocked_by:
      type: string
      description: "contentJobId that unlocked this flashcard"
      required: false
    unlock_progress:
      type: float
      description: "0.0-1.0 for partial matches (Phase 2 gamification)"
      required: false
      default: 0.0
    related_content_ids:
      type: json
      description: "Array of contentJobIds that could unlock this (Phase 2)"
      required: false
    source_timestamp:
      type: string
      description: "Link back to video moment (MM:SS)"
      required: false
    times_reviewed:
      type: integer
      description: "Total review count"
      required: false
      default: 0
    times_correct:
      type: integer
      description: "Count of 'easy' ratings"
      required: false
      default: 0
    last_reviewed_at:
      type: timestamp
      description: "Most recent review"
      required: false
    next_review_at:
      type: timestamp
      description: "When card is due for review (spaced repetition)"
      required: false
      index: true
    created_at:
      type: timestamp
      required: true
    updated_at:
      type: timestamp
      required: true

unlock_events:
  description: "Tracks flashcard unlock history for analytics and gamification"
  source: "unlock service (concept matching pipeline)"
  fields:
    id:
      type: uuid
      description: "Primary key"
      required: true
    user_id:
      type: uuid
      description: "FK to users"
      required: true
      index: true
    flashcard_id:
      type: uuid
      description: "FK to flashcards"
      required: true
      index: true
    content_job_id:
      type: uuid
      description: "FK to content_jobs (what content unlocked this)"
      required: true
      index: true
    concept_match_id:
      type: uuid
      description: "FK to concept_matches (which match triggered unlock)"
      required: true
      index: true
    confidence:
      type: float
      description: "Match confidence that triggered unlock (≥0.70)"
      required: true
    created_at:
      type: timestamp
      required: true

user_stats:
  description: "Aggregate user statistics for dashboard and gamification"
  source: "unlock service (updated after each unlock)"
  fields:
    id:
      type: uuid
      description: "Primary key"
      required: true
    user_id:
      type: uuid
      description: "FK to users (unique)"
      required: true
      index: true
      unique: true
    total_unlocks:
      type: integer
      description: "Total flashcards unlocked"
      required: true
      default: 0
    total_locked:
      type: integer
      description: "Total flashcards still locked"
      required: true
      default: 0
    unlock_rate:
      type: float
      description: "Computed: total_unlocks / (total_unlocks + total_locked)"
      required: false
    created_at:
      type: timestamp
      required: true
    updated_at:
      type: timestamp
      required: true

review_sessions:
  description: "Review session tracking"
  source: "student review UI"
  fields:
    id:
      type: uuid
      description: "Primary key"
      required: true
    user_id:
      type: uuid
      description: "FK to users"
      required: true
      index: true
    course_id:
      type: string
      description: "FK to courses"
      required: true
    flashcard_count:
      type: integer
      description: "Total cards in this session"
      required: true
    current_card_index:
      type: integer
      description: "Current position in session (0-indexed)"
      required: false
      default: 0
    status:
      type: string
      description: "in-progress | completed | abandoned"
      required: true
      index: true
    started_at:
      type: timestamp
      required: true
    completed_at:
      type: timestamp
      description: "When session finished"
      required: false

review_events:
  description: "Individual flashcard review events for analytics"
  source: "student review actions"
  fields:
    id:
      type: uuid
      description: "Primary key"
      required: true
    session_id:
      type: uuid
      description: "FK to review_sessions"
      required: true
      index: true
    flashcard_id:
      type: uuid
      description: "FK to flashcards"
      required: true
      index: true
    difficulty:
      type: string
      description: "easy | medium | hard (for spaced repetition)"
      required: true
    time_to_reveal_ms:
      type: integer
      description: "Time from show to reveal answer (milliseconds)"
      required: false
    time_to_rate_ms:
      type: integer
      description: "Time from reveal to difficulty rating (milliseconds)"
      required: false
    created_at:
      type: timestamp
      required: true
