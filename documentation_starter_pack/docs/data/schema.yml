# Hackathon MVP Schema - 14 Tables (Updated: 2025-11-18)
# JSON Schema format for database tables
# MIGRATION (2025-11-16): Removed academic_years and semesters, added knowledge_nodes and node_syllabus_concepts
# MIGRATION (2025-11-18): VideoJob → ContentJob with ContentType enum, added PDF-specific fields
# MIGRATION (2025-11-18): Added language support for multilingual embeddings (concepts, syllabus_concepts, flashcards)
# MIGRATION (2025-11-18): Added unlock_events and user_stats tables, updated flashcards with unlock fields

---
$id: "https://hackthegap.com/schemas/users.schema.json"
$schema: "http://json-schema.org/draft-07/schema#"
title: users
type: object
required: [id, email, created_at]
properties:
  id:
    type: string
    format: uuid
  email:
    type: string
    format: email
    description: "PII"
  name:
    type: ["string", "null"]
  created_at:
    type: string
    format: date-time

---
$id: "https://hackthegap.com/schemas/subjects.schema.json"
$schema: "http://json-schema.org/draft-07/schema#"
title: subjects
type: object
required: [id, name]
properties:
  id:
    type: string
    format: uuid
  name:
    type: string
    description: "Subject name (Philosophy, Biology, Economics)"
  created_at:
    type: string
    format: date-time

---
$id: "https://hackthegap.com/schemas/courses.schema.json"
$schema: "http://json-schema.org/draft-07/schema#"
title: courses
type: object
required: [id, code, name, subject_id]
properties:
  id:
    type: string
    format: uuid
  code:
    type: string
    description: "Official course code (LU1PH51F, BIOL2001, ECON1101)"
  name:
    type: string
    description: "Course name (Métaphysique, Cell Biology, Intro to Microeconomics)"
  subject_id:
    type: string
    format: uuid
    description: "FK to subjects"
  ue_number:
    type: ["string", "null"]
    description: "UE number (UE 1, UE 2, etc.) for French system"
  syllabus_url:
    type: ["string", "null"]
    description: "Link to syllabus PDF"
  created_at:
    type: string
    format: date-time

---
$id: "https://hackthegap.com/schemas/knowledge_nodes.schema.json"
$schema: "http://json-schema.org/draft-07/schema#"
title: knowledge_nodes
type: object
required: [id, subject_id, name, order]
properties:
  id:
    type: string
    format: uuid
  subject_id:
    type: string
    format: uuid
    description: "FK to subjects"
  parent_id:
    type: ["string", "null"]
    format: uuid
    description: "FK to knowledge_nodes (self-referential for tree structure)"
  name:
    type: string
    description: "Node name (Epistemology, Ethics, Kant, etc.)"
  slug:
    type: ["string", "null"]
    description: "URL-friendly identifier, unique per subject"
  order:
    type: integer
    description: "Display order among siblings"
    default: 0
  metadata:
    type: ["object", "null"]
    description: "Flexible JSON metadata for future extensions"
  created_at:
    type: string
    format: date-time
  updated_at:
    type: string
    format: date-time

---
$id: "https://hackthegap.com/schemas/user_courses.schema.json"
$schema: "http://json-schema.org/draft-07/schema#"
title: user_courses
type: object
required: [user_id, course_id, is_active, learned_count]
properties:
  user_id:
    type: string
    format: uuid
  course_id:
    type: string
    format: uuid
  is_active:
    type: boolean
    description: "Only one active course per user for MVP"
  learned_count:
    type: integer
    description: "Pre-computed count of matched concepts (confidence >=0.8)"
  created_at:
    type: string
    format: date-time

---
$id: "https://hackthegap.com/schemas/syllabus_concepts.schema.json"
$schema: "http://json-schema.org/draft-07/schema#"
title: syllabus_concepts
type: object
required: [id, course_id, concept_text, order, language]
properties:
  id:
    type: string
    format: uuid
  course_id:
    type: string
  concept_text:
    type: string
  category:
    type: ["string", "null"]
    description: "Ethics, Epistemology, etc."
  importance:
    type: integer
    minimum: 1
    maximum: 3
    description: "1=supplemental, 2=important, 3=core"
  order:
    type: integer
  language:
    type: string
    default: en
    description: "Language of syllabus concept (en, fr, es, de, etc.). Used for cross-lingual matching."
  created_at:
    type: string
    format: date-time

---
$id: "https://hackthegap.com/schemas/node_syllabus_concepts.schema.json"
$schema: "http://json-schema.org/draft-07/schema#"
title: node_syllabus_concepts
type: object
required: [node_id, syllabus_concept_id]
properties:
  node_id:
    type: string
    format: uuid
    description: "FK to knowledge_nodes"
  syllabus_concept_id:
    type: string
    format: uuid
    description: "FK to syllabus_concepts"
  added_by_user_id:
    type: ["string", "null"]
    format: uuid
    description: "User who attached this concept (optional)"
  created_at:
    type: string
    format: date-time

---
$id: "https://hackthegap.com/schemas/content_jobs.schema.json"
$schema: "http://json-schema.org/draft-07/schema#"
title: content_jobs
description: "Unified content processing pipeline (formerly video_jobs). Table name remains 'video_jobs' for backward compatibility."
type: object
required: [id, user_id, url, content_type, status]
properties:
  id:
    type: string
    format: uuid
  user_id:
    type: string
    format: uuid
  url:
    type: string
    description: "Source URL (YouTube, TikTok, PDF URL, article URL, podcast URL)"
  content_type:
    type: string
    enum: [youtube, tiktok, pdf, url, podcast]
    default: youtube
    description: "Content type enum for polymorphic processing"
  youtube_video_id:
    type: ["string", "null"]
    description: "Video-specific: YouTube video ID"
  tiktok_video_id:
    type: ["string", "null"]
    description: "Video-specific: TikTok video ID"
  file_name:
    type: ["string", "null"]
    description: "PDF-specific: Original filename"
  file_size:
    type: ["integer", "null"]
    description: "PDF-specific: File size in bytes"
  page_count:
    type: ["integer", "null"]
    description: "PDF-specific: Number of pages"
  extracted_text:
    type: ["string", "null"]
    description: "Extracted text from any content type (transcript for videos, text for PDFs). Column name: 'transcript' (mapped via @map)"
  status:
    type: string
    enum: [transcript_fetched, processing, completed, failed, cancelled]
    description: "transcript_fetched = Phase 1 complete, processing = AI extraction in progress"
  processed_concepts_count:
    type: ["integer", "null"]
    description: "For 'Extracted 4 concepts' message"
  error_message:
    type: ["string", "null"]
  created_at:
    type: string
    format: date-time
  completed_at:
    type: ["string", "null"]
    format: date-time

---
$id: "https://hackthegap.com/schemas/concepts.schema.json"
$schema: "http://json-schema.org/draft-07/schema#"
title: concepts
type: object
required: [id, content_job_id, concept_text, confidence, language]
properties:
  id:
    type: string
    format: uuid
  content_job_id:
    type: string
    format: uuid
    description: "FK to content_jobs (column name: 'videoJobId' via @map for backward compatibility)"
  concept_text:
    type: string
  definition:
    type: ["string", "null"]
  timestamp:
    type: ["string", "null"]
    description: "MM:SS format (video-specific, null for PDFs/articles)"
  confidence:
    type: number
    minimum: 0
    maximum: 1
  language:
    type: string
    default: en
    description: "Detected language of concept (en, fr, es, de, etc.). Preserved from original content."
  created_at:
    type: string
    format: date-time

---
$id: "https://hackthegap.com/schemas/concept_matches.schema.json"
$schema: "http://json-schema.org/draft-07/schema#"
title: concept_matches
type: object
required: [id, concept_id, syllabus_concept_id, confidence]
properties:
  id:
    type: string
    format: uuid
  concept_id:
    type: string
    format: uuid
  syllabus_concept_id:
    type: string
    format: uuid
  confidence:
    type: number
    minimum: 0
    maximum: 1
  match_type:
    type: ["string", "null"]
    enum: [exact, related, example-of, no-match]
  rationale:
    type: ["string", "null"]
  user_feedback:
    type: ["string", "null"]
    enum: [correct, incorrect, uncertain]
    description: "MVP: data collection only"
  created_at:
    type: string
    format: date-time

---
$id: "https://hackthegap.com/schemas/flashcards.schema.json"
$schema: "http://json-schema.org/draft-07/schema#"
title: flashcards
type: object
required: [id, syllabus_concept_id, user_id, question, language, state]
properties:
  id:
    type: string
    format: uuid
  syllabus_concept_id:
    type: string
    format: uuid
    description: "FK to syllabus_concepts (always present)"
  concept_match_id:
    type: ["string", "null"]
    format: uuid
    description: "FK to concept_matches (NULL = locked, NOT NULL = unlocked)"
  user_id:
    type: string
    format: uuid
  question:
    type: string
    description: "Always present (from syllabus)"
  answer:
    type: ["string", "null"]
    description: "NULL = locked, NOT NULL = unlocked"
  question_translation:
    type: ["string", "null"]
    description: "Translation of question (for bilingual flashcards when language mismatch detected)"
  answer_translation:
    type: ["string", "null"]
    description: "Translation of answer (for bilingual flashcards when language mismatch detected)"
  language:
    type: string
    default: en
    description: "Primary language of flashcard (en, fr, es, de, etc.)"
  difficulty:
    type: string
    enum: [easy, medium, hard]
    default: medium
  hints:
    type: ["array", "null"]
    description: "Array of hint strings (available when locked)"
    items:
      type: string
  state:
    type: string
    enum: [locked, unlocked, mastered]
    default: locked
    description: "locked = question-only, unlocked = answer revealed, mastered = consistently correct"
  unlocked_at:
    type: ["string", "null"]
    format: date-time
    description: "When answer was revealed"
  unlocked_by:
    type: ["string", "null"]
    description: "contentJobId that unlocked this flashcard"
  unlock_progress:
    type: number
    minimum: 0
    maximum: 1
    default: 0.0
    description: "0.0-1.0 for partial matches (Phase 2 gamification)"
  related_content_ids:
    type: ["array", "null"]
    description: "Array of contentJobIds that could unlock this (Phase 2)"
    items:
      type: string
  source_timestamp:
    type: ["string", "null"]
    description: "Link back to video moment"
  times_reviewed:
    type: integer
    default: 0
  times_correct:
    type: integer
    default: 0
  last_reviewed_at:
    type: ["string", "null"]
    format: date-time
  next_review_at:
    type: ["string", "null"]
    format: date-time
    description: "For spaced repetition scheduling"
  created_at:
    type: string
    format: date-time
  updated_at:
    type: string
    format: date-time

---
$id: "https://hackthegap.com/schemas/review_sessions.schema.json"
$schema: "http://json-schema.org/draft-07/schema#"
title: review_sessions
type: object
required: [id, user_id, course_id, flashcard_count, status]
properties:
  id:
    type: string
    format: uuid
  user_id:
    type: string
    format: uuid
  course_id:
    type: string
  flashcard_count:
    type: integer
  current_card_index:
    type: integer
    default: 0
  status:
    type: string
    enum: [in-progress, completed, abandoned]
  started_at:
    type: string
    format: date-time
  completed_at:
    type: ["string", "null"]
    format: date-time

---
$id: "https://hackthegap.com/schemas/review_events.schema.json"
$schema: "http://json-schema.org/draft-07/schema#"
title: review_events
type: object
required: [id, session_id, flashcard_id, difficulty]
properties:
  id:
    type: string
    format: uuid
  session_id:
    type: string
    format: uuid
  flashcard_id:
    type: string
    format: uuid
  difficulty:
    type: string
    enum: [easy, medium, hard]
  time_to_reveal_ms:
    type: ["integer", "null"]
  time_to_rate_ms:
    type: ["integer", "null"]
  created_at:
    type: string
    format: date-time

---
$id: "https://hackthegap.com/schemas/unlock_events.schema.json"
$schema: "http://json-schema.org/draft-07/schema#"
title: unlock_events
type: object
description: "Tracks flashcard unlock history for analytics and gamification"
required: [id, user_id, flashcard_id, content_job_id, concept_match_id, confidence]
properties:
  id:
    type: string
    format: uuid
  user_id:
    type: string
    format: uuid
    description: "FK to users"
  flashcard_id:
    type: string
    format: uuid
    description: "FK to flashcards"
  content_job_id:
    type: string
    format: uuid
    description: "FK to content_jobs (what content unlocked this)"
  concept_match_id:
    type: string
    format: uuid
    description: "FK to concept_matches (which match triggered unlock)"
  confidence:
    type: number
    minimum: 0
    maximum: 1
    description: "Match confidence that triggered unlock (≥0.70)"
  created_at:
    type: string
    format: date-time

---
$id: "https://hackthegap.com/schemas/user_stats.schema.json"
$schema: "http://json-schema.org/draft-07/schema#"
title: user_stats
type: object
description: "Aggregate user statistics for dashboard and gamification"
required: [id, user_id, total_unlocks, total_locked]
properties:
  id:
    type: string
    format: uuid
  user_id:
    type: string
    format: uuid
    description: "FK to users (unique)"
  total_unlocks:
    type: integer
    default: 0
    description: "Total flashcards unlocked"
  total_locked:
    type: integer
    default: 0
    description: "Total flashcards still locked"
  unlock_rate:
    type: ["number", "null"]
    minimum: 0
    maximum: 1
    description: "Computed: total_unlocks / (total_unlocks + total_locked)"
  created_at:
    type: string
    format: date-time
  updated_at:
    type: string
    format: date-time

---
$id: "https://hackthegap.com/schemas/concept_localizations.schema.json"
$schema: "http://json-schema.org/draft-07/schema#"
title: concept_localizations
type: object
description: "TODO (2025-11-17): Planned table for bilingual concept text (EN/FR)"
required: [id, concept_id, locale, concept_text]
properties:
  id:
    type: string
    format: uuid
  concept_id:
    type: string
    format: uuid
    description: "FK to concepts (canonical)"
  locale:
    type: string
    enum: [en, fr]
  concept_text:
    type: string
  metadata:
    type: ["object", "null"]
  created_at:
    type: string
    format: date-time

---
$id: "https://hackthegap.com/schemas/flashcard_localizations.schema.json"
$schema: "http://json-schema.org/draft-07/schema#"
title: flashcard_localizations
type: object
description: "TODO (2025-11-17): Planned table for bilingual flashcards (EN/FR)"
required: [id, flashcard_id, locale, question, answer]
properties:
  id:
    type: string
    format: uuid
  flashcard_id:
    type: string
    format: uuid
    description: "FK to flashcards (canonical)"
  locale:
    type: string
    enum: [en, fr]
  question:
    type: string
  answer:
    type: string
  hint:
    type: ["string", "null"]
  explanation:
    type: ["string", "null"]
  metadata:
    type: ["object", "null"]
  created_at:
    type: string
    format: date-time
